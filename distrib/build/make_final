#! /tools/bin/bash
#
# SmoothWall Build system.
#
# Parts (c) SmoothWall Ltd 2005
# Parts (c) Neal P. Murphy, 2009
#
# This code is distributed under the terms of the GPL v2.


# First, look for /build. If it ain't found, this probably is not a chroot
#   jail, it was probably run manually, so die.
#
if [ ! -d "/build" ]; then
  exit 1
fi


# At this point, we must assume we are in a chroot jail.

# Now trap on exit, to be sure proc is unmounted. Note that this does not change
#   the exit status of the shell (only an explicit exit would do that).
#   This is needed so the host OS doesn't complain when shutting down.
#
trap "echo; echo \"Unmounting /proc\"; umount /proc" EXIT

# If an argument specified, build only that item. Otherwise, build everything.
#
if [ "$#" -eq 2 ]; then
  TO_BUILD="$1"
  THE_TARGET="$2"
elif [ "$#" -eq 1 ]; then
  TO_BUILD="$1"
  THE_TARGET=""
else
  TO_BUILD=""
  THE_TARGET=""
fi

# The right place, the right phase
#
cd /build
export BUILD_PHASE="Final"

# Get our functions
#
source environment
source functions

set_build_environment

# Be sure /proc is mounted
#
if grep proc /etc/mtab; then umount /proc >/dev/null 2>&1; fi
mount -t proc proc /proc

# Set up parallel make
#
export JOBS_UP="-j 1"
export JOBS_MP
cpu_count


# If unwinding, do so and exit
#
if [ "$TO_BUILD" == "--unwind" ]; then
  bash final_tc_adjustment --unwind
  exit $?
fi

# If building only a specific package, do so and exit
#
if [ "$TO_BUILD" != "" ]; then

  # Build only the specified package
  JOBS=$JOBS_MP
  build $TO_BUILD $THE_TARGET
  exit $?
fi

# Must be building all of the final stage
#
  JOBS=$JOBS_MP

  if [ -e crumbs/Final.compiled ]; then
    echo -e "\n    Final phase packages already compiled"
  else
    echo
    if [ -e crumbs/Final.grp1.compiled ]; then
      echo -e "    Final group 1 packages already built"
    else
      echo
      build kernel-headers
      build glibc
      other_cmd "crumbs/$BUILD_PHASE.toolchain.adjusted" \
                "final toolchain adjustment" \
                "bash final_tc_adjustment" \
                "crumbs/$BUILD_PHASE.adjusting.out"
      build binutils
      build gcc
      other_cmd "crumbs/$BUILD_PHASE.toolchain.verified" \
                "final toolchain verification" \
                "bash final_tc_check" \
                "crumbs/$BUILD_PHASE.verification.out"
      build gcc libgcc
      build coreutils
      build zlib
      build mktemp
      build iana-etc
      build findutils
      build gawk
      build ncurses
      build vim
      build nano
      build m4
      build bison
      build less
      JOBS=$JOBS_UP
      build groff
      JOBS=$JOBS_MP
      build man
      build man-pages
      build sed
      build flex
      build dejagnu
      build gettext
      JOBS=$JOBS_UP
      build net-tools
      JOBS=$JOBS_MP
      build inetutils
      touch crumbs/Final.grp1.compiled
    fi

    if [ -e crumbs/Final.grp2.compiled ]; then
      echo -e "    Final group 2 packages already built"
    else
      echo
      build iputils
      build traceroute
      build perl
      build Net-Netmask
      build NetAddr-IP
      build HTML-Parser
      build HTML-Tagset
      build URI
      build libwww-perl
      build texinfo
      build autoconf
      build automake
      build bash
      build file
      build libtool
      build bzip2
      build diffutils
      build kbd
      build e2fsprogs
      build grep
      build gzip
      build make
      build module-init-tools
      build patch
      build pkg-config
      build procinfo
      build procps
      touch crumbs/Final.grp2.compiled
    fi

    if [ -e crumbs/Final.grp3.compiled ]; then
      echo -e "    Final group 3 packages already built"
    else
      echo
      build psmisc
      build shadow
      build sysklogd
      build sysvinit
      build tar
      build util-linux-ng
      build joe
      build openssl
      build wget
      build sudo
      build iptables unpack
      build kernel-phaeton
      build iptables
      build xtables-addons
      #build ipp2p: obsolete, included in xtables-addons
      build ipbatch
      build klibc
      #build libipt_ACCOUNT: obsolete, included in xtables-addons
      build listtables
      build udev
      #build udev-config; not needing?
      build pciutils
      build bin86
      build nasm
      build strace
      build lilo
      build linux-atm
      build libcap
      build hdparm
      build hddtemp
      build iproute2
      touch crumbs/Final.grp3.compiled
    fi

    if [ -e crumbs/Final.grp4.compiled ]; then
      echo -e "    Final group 4 packages already built"
    else
      echo
      build sash
      build gmp
      build pcre
      build beep2
      build libpcap
      build tcpdump

      build dosfstools
      build syslinux
      build openssh
      #build apache
      build httpd
      build smoothd
      build cron
      JOBS=$JOBS_UP
      build at
      JOBS=$JOBS_MP
      build cgilib
      build freetype
      build libart_lgpl
      build libpng
      build rrdtool
      build lm_sensors
      build dnsmasq
      build whois
      build popt
      build logrotate
      build expat
      build ethtool
      build iftop
      touch crumbs/Final.grp4.compiled
    fi

    if [ -e crumbs/Final.grp5.compiled ]; then
      echo -e "    Final group 5 packages already built"
    else
      echo
      build which

      build ntp
      build openntpd

      build slang
      build newt

      build squid
      build gd

      build libsmooth+setup

      build trafficstats

      build mtools
      build cdrtools
      build busybox

      build setuids

      build ppp
      build isdn4k-utils
      #build speedtouch: obsolete, built into kernel >= 2.6.10
      build rp-pppoe
      build ibod
      build dhcpcd
      build eciadsl-synch_bin
      build eciadsl-usermode
      #build eagle-usb: obsolete, replaced by ueagle-atm, in kernel >= 2.6.16
      build cnxadsl

      build dhcp
      JOBS=$JOBS_UP
      build snort
      JOBS=$JOBS_MP
      build coretree
      build oinkmaster
      build openswan
      touch crumbs/Final.grp5.compiled
    fi

    if [ -e crumbs/Final.grp6.compiled ]; then
      echo -e "    Final group 6 packages already built"
    else
      echo

      build wireless_tools

      build noip
      build ez-ipupdate

      build imspector

      build clamav
      build p3scan

      build tcl
      build apr
      build apr-util
      build neon
      build git
      build screen
      build gdb
      build lynx
      #build install

      build libosip2
      build siproxd

      # miniupnpd has build problems; skipping
      build miniupnpd
      build cpio
      build grub
      build reiserfsprogs

      touch crumbs/Final.grp6.compiled
    fi

    touch crumbs/Final.compiled
  fi
  echo
