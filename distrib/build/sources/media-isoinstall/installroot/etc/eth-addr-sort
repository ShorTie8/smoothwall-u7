#! /bin/bash

typeset -i j
j=0


cd /sys/class/net

# Wait for the NICs to appear
set eth*/address
while [ "$1" == "eth*/address" ]; do
  sleep 1
  set eth*/address
done

mkdir -p /etc/udev/rules.d

# Every IF that has a MAC address is assumed to be a NIC, even bridges
for i in *; do
  addr=`cat $i/address`
  if [ "$addr" != "" -a "$addr" != "00:00:00:00:00:00" ]; then
    echo "$addr $i"
  fi
done | sort | while read addr eth; do
  sed -i -e '/'$addr'/ s/NAME="[^"]*"/NAME="eth'$j'"/' /etc/udev/rules.d/70-persistent-net.rules
  echo "  $eth -> eth$j"
  j=j+1
done
