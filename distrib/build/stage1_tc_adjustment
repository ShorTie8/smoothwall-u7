#! /bin/bash

echo
echo "Stage 1 toolchain adjustment"
echo

# Get environs
#
. ./environment
set_build_environment

# Initialize STATUS
#
STATUS=0

#################

# First, 

# Make sure gcc's libgcc has a path
#
GCC_LIBNAM=`gcc -print-libgcc-file-name`
GCC_LIBNAMDIR=`dirname ${GCC_LIBNAM}`
if [ "${GCC_LIBNAMDIR}" == "" ]; then
  echo "'gcc -print-libgcc-file-name' doesn't have a path name!"
  exit -10
fi

# Make sure the include-fixed dir exists (should by default for
#   newer kernels)
#
GCC_LIBNAM=`gcc -print-libgcc-file-name`
GCC_LIBNAMDIR=`dirname ${GCC_LIBNAM}`
GCC_FIXED="${GCC_LIBNAMDIR}/include-fixed"
if [ "${GCC_FIXED}" == "" ]; then
  echo "'gcc's include-fixed directory doesn't exist!"
  exit -11
fi

# Tweak loader from last binutils compile
#
mv -v ${TOOLS_DIR}/bin/{ld,ld-old}
mv -v ${TOOLS_DIR}/$(gcc -dumpmachine)/bin/{ld,ld-old}
mv -v ${TOOLS_DIR}/bin/{ld-new,ld}
ln -sv ${TOOLS_DIR}/bin/ld ${TOOLS_DIR}/$(gcc -dumpmachine)/bin/ld

# Tweak gcc specs
#
gcc -dumpspecs | sed \
        -e 's@/lib/ld-linux.so.2@'${TOOLS_DIR}'/lib/ld-linux.so.2@g' \
        -e 's@/lib64/ld-linux-x86-64.so.2@'${TOOLS_DIR}'/lib64/ld-linux-x86-64.so.2@g' \
        > `dirname $(gcc --print-libgcc-file-name)`/specs

# Clean up fixed header files
find ${GCC_FIXED}/* -maxdepth 0 -xtype d -exec rm -rvf '{}' \; && \
  rm -vf "grep -l "DO NOT EDIT THIS FILE" ${GCC_FIXED}/*"

#################

# Now check for gcc environs problems. These must all be correct
#   before proceeding to finish the final build!

# Does 'cc' exist as symlink?
if [ "`readlink -n -s ${TOOLS_DIR}/bin/cc`" != "gcc" ]; then
  echo "cc as symlink to gcc not found!"
  STATUS=1
fi

# Verify that the final build environment is correct.

# compile an empty program
#
echo 'main(){}' > dummy.c
cc dummy.c > dummy.log

# Right program interpreter?
#
readelf -l a.out | grep ": ${TOOLS_DIR}/lib" >/dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "gcc uses wrong program interpreter!"
  STATUS=1
fi


#################

# Now clean up and finish up

# Inform if errors are found
#
if [ $STATUS -eq 1 ]; then
  echo
  echo
  echo "Errors found! Reversing adjustment..."
  echo

  rm -fv `dirname $(gcc --print-libgcc-file-name)`/specs
  rm -v ${TOOLS_DIR}/$(gcc -dumpmachine)/bin/ld
  mv -v ${TOOLS_DIR}/bin/{ld,ld-new}
  mv -v ${TOOLS_DIR}/$(gcc -dumpmachine)/bin/{ld-old,ld}
  mv -v ${TOOLS_DIR}/bin/{ld-old,ld}

  exit 1

else

  # All is well; it is safe to proceed!
  #
  rm -f dummy.c dummy.log a.out
  exit 0

fi
