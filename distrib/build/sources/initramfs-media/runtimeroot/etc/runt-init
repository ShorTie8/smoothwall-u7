#!/bin/bash

echo "Loading, please wait..."

[ -d /dev ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
[ -d /tmp ] || mkdir /tmp

echo "Mounting sys, proc"
mkdir -p /var/lock
mount -t sysfs -o nodev,noexec,nosuid none /sys 
mount -t proc -o nodev,noexec,nosuid none /proc 

echo "Making some needed /dev entries"
test -e /dev/console || mknod -m0600 /dev/console c 5 1
test -e /dev/null || mknod -m0777 /dev/null c 1 3

echo "Mounting real root read/write"
mount -n -o remount,rw /

echo "depmod"
depmod -a

echo "Clearing mtab"
>/etc/mtab

echo "Marking root as mounted"
mount -f /

# Mounting and populating dev
/etc/udev.rc

echo "Starting USB"
/sbin/modprobe usbcore
/sbin/modprobe ohci-hcd
/sbin/modprobe uhci-hcd
/sbin/modprobe ehci-hcd
/sbin/modprobe usbhid
/bin/mount -t usbfs busprocusb /proc/bus/usb

echo "1 4 1 7" >/proc/sys/kernel/printk

test -e /etc/modules && egrep -v "^$|^#" | while read a; do modprobe $a; done

# Switch to hard drive and start the system
mount /dev/harddisk4 /harddisk -o ro

# Stop udevd, we'll miss a few events while we run init, but we catch up
for proc in /proc/[0-9]*; do
    [ -x $proc/exe ] || continue
    [ "$(/usr/lib/klibc/bin/readlink $proc/exe)" != /bin/udevd ] || kill ${proc#/proc/}
done

mount -n -o move /dev /harddisk/dev

/usr/lib/klibc/bin/nuke /dev
ln -s /harddisk/dev /dev

mount -n -o move /sys /harddisk/sys
mount -n -o move /proc /harddisk/proc

exec /usr/lib/klibc/bin/run-init /harddisk /sbin/init </harddisk/dev/console >/harddisk/dev/console 2>&1
